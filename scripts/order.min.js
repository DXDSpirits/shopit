!function(){moment.lang("zh-cn");var e=_.debounce(function(){$(".views-wrapper").height($(window).height())},300);$(window).resize(e),e(),$("body").on("click","[data-route]",function(e){var i=$(e.currentTarget).data("route");"return"==i?window.history.back():"preview"==i?t.previewStory(t.story.get("name")):t.router.navigate(i)});var t={Version:"1.0.0",Models:{},Views:{},Pages:{}};t.pageRouter=new function(e){this.pages=e,this.history={active:null,stack:[]},this.goTo=function(e,t){var i=this.pages[e],o=_.last(this.history.stack);(t||(t={})).caller=t.caller||this.history.active,i&&(i==o?(this.history.active.leave(),this.pushNext?this.history.stack.push(this.history.active):this.history.stack.length-=1,t.reverse=!this.pushNext,i.go(t),this.history.active=i):(this.history.active&&(this.history.active.leave(),this.history.stack.push(this.history.active)),i.go(t),this.history.active=i)),this.pushNext=!1},this.clearHistory=function(){this.history.stack.length=0},this.refreshActivePage=function(){this.history.active.refresh()},this.goBack=function(){if(this.history.stack.length>0){var e=this.history.stack.pop();this.history.active=e,this.history.active.showPage({reverse:!0})}},this.pop=function(){if(this.history.stack.length>0){var e=this.history.stack.pop();this.history.active=e}}}(t.Pages),t.getTemplate=function(e){return $("#template-"+e).html()};var i,o,s=500;Amour.ajax.on("start",function(){clearTimeout(i),clearTimeout(o),$("#apploader").removeClass("invisible")}),Amour.ajax.on("stop",function(){i=setTimeout(function(){$("#apploader").addClass("invisible"),s=500},s)}),Amour.ajax.on("error",function(){$("#apploader .ajax-error").removeClass("hidden"),o=setTimeout(function(){$("#apploader .ajax-error").addClass("hidden")},s=1500)}),Amour.ajax.on("unauthorized",function(){var e="/accounts/?url="+encodeURIComponent(location.href);t.openUrl(e,{replace:!0})}),Amour.ajax.on("forbidden",function(){var e="/accounts/?url403="+encodeURIComponent(location.href);t.openUrl(e,{replace:!0})}),t.vent=new Amour.EventAggregator,t.start=function(){Amour.trigger("ComposerAppReady"),Backbone.history.start()},window.App=t}(),function(){App.PageView=Amour.View.extend({disablePage:function(){this.undelegateEvents(),this.go=function(){},this.refresh=function(){},this.showPage=function(){}},initView:function(){if(!this.el)return void this.disablePage();this.views={},_.bindAll(this,"showPage","go","refresh","render","reset");var e=this.$el;this.$(".wrapper").on("webkitAnimationEnd",function(t){var i=t.originalEvent.animationName;"slideouttoleft"==i||"slideouttoright"==i?e.trigger("pageClose"):("slideinfromright"==i||"slideinfromleft"==i)&&e.trigger("pageOpen")}),this.initPage&&this.initPage()},leave:function(){},go:function(e){this.options=e||{},this.reset();var t=this.render,i=_.once(function(){t()});_.delay(i,1e3),this.$el.one("pageOpen",i),this.showPage()},refresh:function(){var e=this.render,t=_.once(function(){e()});_.delay(t,1e3),this.$el.one("pageOpen",t),this.showPage()},reset:function(){},showPage:function(e){var t,e=e||this.options||{},i=!this.$el.hasClass("view-hidden");i?(t=this.$el.clone().prependTo(".views-wrapper"),t.find(".wrapper").scrollTop(this.$(".wrapper").scrollTop()),this.$el.addClass("view-hidden")):t=$('.view:not(".view-hidden")');var o=_.once(function(){t.removeClass("view-prev").removeClass("view-prev-reverse"),i?t.remove():t.addClass("view-hidden"),t.find("input").blur()});t.addClass("view-prev"),e.reverse&&t.addClass("view-prev-reverse"),_.delay(o,1e3),t.one("pageClose",o);var s=this.$el,r=_.once(function(){s.removeClass("view-next").removeClass("view-next-reverse"),s.find("input").blur(),window.scrollTo(0,0)});s.removeClass("view-hidden"),s.addClass("view-next"),e.reverse&&s.addClass("view-next-reverse"),_.delay(r,1e3),s.one("pageOpen",r)}})}(),function(){var e=App.pageRouter;App.router=new(Backbone.Router.extend({navigate:function(t,i){i=i||{},i.trigger=!(i.trigger===!1),i.replace&&e.pop(),e.pushNext=!0,Backbone.Router.prototype.navigate.call(this,t,i)},initialize:function(){this.route("*path","index"),this.route(/neworder\/(\d+)/,"neworder"),this.route(/address/,"address")},index:function(e){this.navigate("neworder/3385",{replace:!0})},neworder:function(t){e.goTo("NewOrder",{productId:t})},address:function(t){e.goTo("MyAddresses")}}))}(),function(){var e=9,t=Amour.Model.extend({url:Amour.APIRoot+"beacon/data/getItemBycityName.do"}),i=Amour.Collection.extend({url:Amour.APIRoot+"beacon/data/listSameCategoryItemsByid.do"}),o=Amour.Collection.extend({url:Amour.APIRoot+"beacon/data/listItemByBid.do"}),s=Amour.ModelView.extend({template:App.getTemplate("product-detail")}),r=Amour.CollectionView.extend({ModelView:Amour.ModelView.extend({events:{click:"viewDetail"},className:"media-item",template:'<div class="img" data-bg-src="{{apiFullpath img}}"></div><div class="name">{{name}}</div><div>￥{{price}}</div>',viewDetail:function(){App.router.navigate("product/"+this.model.id)}})});App.Pages.NewOrder=new(App.PageView.extend({events:{"click .store .btn":"viewStores"},initPage:function(){this.product=new t,this.similarProducts=new i,this.brandProducts=new o,this.views={product:new s({model:this.product,el:this.$(".product-wrapper")}),similarProducts:new r({collection:this.similarProducts,el:this.$(".similar-products .media-list")}),brandProducts:new r({collection:this.brandProducts,el:this.$(".brand-products .media-list")})}},viewStores:function(){App.router.navigate(["product",this.product.id,"address"].join("/"))},render:function(){var t=this.options.productId,i=this;this.product.fetch({dataType:"jsonp",data:{id:t},success:function(t){var o=i.product.get("brand").id;i.brandProducts.fetch({dataType:"jsonp",data:{id:o,start:0,size:e}}),i.$(".store").toggleClass("hidden",1==t.get("online"))}}),this.similarProducts.fetch({dataType:"jsonp",data:{id:t,size:e}})}}))({el:$("#view-new-order")})}(),function(){var e=new function(){var e=this;this.get=function(t){this.coords?t(this.coords):navigator.geolocation.getCurrentPosition(function(i){e.coords={latitude:i.coords.latitude,longitude:i.coords.longitude},t(e.coords)})},this.distance=function(e,t,i,o){var e=e*Math.PI/180,t=t*Math.PI/180,i=i*Math.PI/180,o=o*Math.PI/180,s=6371,r=(o-t)*Math.cos((e+i)/2),n=i-e,a=Math.sqrt(r*r+n*n)*s;return a>1?parseInt(10*a)/10+"km":parseInt(1e3*a)+"m"}},t=Amour.Collection.extend({}),i=Amour.CollectionView.extend({ModelView:Amour.ModelView.extend({className:"address-item",template:App.getTemplate("address-item"),render:function(){Amour.ModelView.prototype.render.call(this);var t=this;return e.get(function(i){var o=e.distance(t.model.get("lat"),t.model.get("lng"),i.latitude,i.longitude);t.$(".distance").text(o)}),this}})});App.Pages.MyAddresses=new(App.PageView.extend({initPage:function(){this.address=new t,this.views={address:new i({collection:this.address,el:this.$(".address-list")})}},render:function(){var e,t;this.options.brandId?(e=this.options.brandId,t=Amour.APIRoot+"beacon/data/listBrandStores.do"):(e=this.options.productId,t=Amour.APIRoot+"beacon/data/listStoresByItemid.do"),this.address.fetch({dataType:"jsonp",url:t,data:{id:e,cityName:"北京市"}})}}))({el:$("#view-my-addresses")})}(),App.start();