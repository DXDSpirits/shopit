!function(){moment.lang("zh-cn");var e=_.debounce(function(){$(".views-wrapper").height($(window).height())},300);$(window).resize(e),e(),$("body").on("click","[data-route]",function(e){var i=$(e.currentTarget).data("route");"return"==i?window.history.back():"preview"==i?t.previewStory(t.story.get("name")):t.router.navigate(i)});var t={Version:"1.0.0",Models:{},Views:{},Pages:{}};t.pageRouter=new function(e){this.pages=e,this.history={active:null,stack:[]},this.goTo=function(e,t){var i=this.pages[e],o=_.last(this.history.stack);(t||(t={})).caller=t.caller||this.history.active,i&&(i==o?(this.history.active.leave(),this.pushNext?this.history.stack.push(this.history.active):this.history.stack.length-=1,t.reverse=!this.pushNext,i.go(t),this.history.active=i):(this.history.active&&(this.history.active.leave(),this.history.stack.push(this.history.active)),i.go(t),this.history.active=i)),this.pushNext=!1},this.clearHistory=function(){this.history.stack.length=0},this.refreshActivePage=function(){this.history.active.refresh()},this.goBack=function(){if(this.history.stack.length>0){var e=this.history.stack.pop();this.history.active=e,this.history.active.showPage({reverse:!0})}},this.pop=function(){if(this.history.stack.length>0){var e=this.history.stack.pop();this.history.active=e}}}(t.Pages),t.getTemplate=function(e){return $("#template-"+e).html()};var i,o,a=500;Amour.ajax.on("start",function(){clearTimeout(i),clearTimeout(o),$("#apploader").removeClass("invisible")}),Amour.ajax.on("stop",function(){i=setTimeout(function(){$("#apploader").addClass("invisible"),a=500},a)}),Amour.ajax.on("error",function(){$("#apploader .ajax-error").removeClass("hidden"),o=setTimeout(function(){$("#apploader .ajax-error").addClass("hidden")},a=1500)}),Amour.ajax.on("unauthorized",function(){var e="/accounts/?url="+encodeURIComponent(location.href);t.openUrl(e,{replace:!0})}),Amour.ajax.on("forbidden",function(){var e="/accounts/?url403="+encodeURIComponent(location.href);t.openUrl(e,{replace:!0})}),t.vent=new Amour.EventAggregator,t.start=function(){Amour.trigger("ComposerAppReady"),Backbone.history.start()},window.App=t}(),function(){App.PageView=Amour.View.extend({disablePage:function(){this.undelegateEvents(),this.go=function(){},this.refresh=function(){},this.showPage=function(){}},initView:function(){if(!this.el)return void this.disablePage();this.views={},_.bindAll(this,"showPage","go","refresh","render","reset");var e=this.$el;this.$(".wrapper").on("webkitAnimationEnd",function(t){var i=t.originalEvent.animationName;"slideouttoleft"==i||"slideouttoright"==i?e.trigger("pageClose"):("slideinfromright"==i||"slideinfromleft"==i)&&e.trigger("pageOpen")}),this.initPage&&this.initPage()},leave:function(){},go:function(e){this.options=e||{},this.reset();var t=this.render,i=_.once(function(){t()});_.delay(i,1e3),this.$el.one("pageOpen",i),this.showPage()},refresh:function(){var e=this.render,t=_.once(function(){e()});_.delay(t,1e3),this.$el.one("pageOpen",t),this.showPage()},reset:function(){},showPage:function(e){var t,e=e||this.options||{},i=!this.$el.hasClass("view-hidden");i?(t=this.$el.clone().prependTo(".views-wrapper"),t.find(".wrapper").scrollTop(this.$(".wrapper").scrollTop()),this.$el.addClass("view-hidden")):t=$('.view:not(".view-hidden")');var o=_.once(function(){t.removeClass("view-prev").removeClass("view-prev-reverse"),i?t.remove():t.addClass("view-hidden"),t.find("input").blur()});t.addClass("view-prev"),e.reverse&&t.addClass("view-prev-reverse"),_.delay(o,1e3),t.one("pageClose",o);var a=this.$el,s=_.once(function(){a.removeClass("view-next").removeClass("view-next-reverse"),a.find("input").blur(),window.scrollTo(0,0)});a.removeClass("view-hidden"),a.addClass("view-next"),e.reverse&&a.addClass("view-next-reverse"),_.delay(s,1e3),a.one("pageOpen",s)}})}(),function(){var e=App.pageRouter;App.router=new(Backbone.Router.extend({navigate:function(t,i){i=i||{},i.trigger=!(i.trigger===!1),i.replace&&e.pop(),e.pushNext=!0,Backbone.Router.prototype.navigate.call(this,t,i)},initialize:function(){this.route("*path","index"),this.route(/product\/(\d+)/,"product"),this.route(/brand\/(\d+)/,"brand"),this.route(/topic\/(\d+)/,"topic")},index:function(e){this.navigate("topic/96",{replace:!0})},product:function(t){e.goTo("Product",{productId:t})},brand:function(t){e.goTo("Brand",{brandId:t})},topic:function(t){e.goTo("Topic",{topicId:t})}}))}(),function(){var e=9,t=Amour.Model.extend({url:Amour.APIRoot+"beacon/data/getItemBycityName.do"}),i=Amour.Collection.extend({url:Amour.APIRoot+"beacon/data/listSameCategoryItemsByid.do"}),o=Amour.Collection.extend({url:Amour.APIRoot+"beacon/data/listItemByBid.do"}),a=Amour.ModelView.extend({template:App.getTemplate("product-detail")}),s=Amour.CollectionView.extend({ModelView:Amour.ModelView.extend({events:{click:"viewDetail"},className:"media-item",template:'<div class="img" data-bg-src="{{apiFullpath img}}"></div><div class="name">{{name}}</div><div>{{price}}</div>',viewDetail:function(){App.router.navigate("product/"+this.model.id)}})});App.Pages.Product=new(App.PageView.extend({initPage:function(){this.product=new t,this.similarProducts=new i,this.brandProducts=new o,this.views={product:new a({model:this.product,el:this.$(".product-wrapper")}),similarProducts:new s({collection:this.similarProducts,el:this.$(".similar-products .media-list")}),brandProducts:new s({collection:this.brandProducts,el:this.$(".brand-products .media-list")})}},render:function(){var t=this.options.productId,i=this;this.product.fetch({dataType:"jsonp",data:{id:t},success:function(t){var o=i.product.get("brand").id;i.brandProducts.fetch({dataType:"jsonp",data:{id:o,start:0,size:e}})}}),this.similarProducts.fetch({dataType:"jsonp",data:{id:t,size:e}})}}))({el:$("#view-product")})}(),function(){var e=9,t=Amour.Model.extend({url:Amour.APIRoot+"beacon/data/getBrand.do"}),i=Amour.Collection.extend({mediaType:"product",url:Amour.APIRoot+"beacon/data/listItemByBid.do"}),o=Amour.Collection.extend({mediaType:"topic",url:Amour.APIRoot+"beacon/data/listTopicByBid.do"}),a=Amour.ModelView.extend({template:App.getTemplate("brand-detail")}),s=Amour.CollectionView.extend({ModelView:Amour.ModelView.extend({events:{click:"viewDetail"},className:"media-item",template:function(){return"product"==this.model.collection.mediaType?'<div class="img" data-bg-src="{{apiFullpath img}}"><div class="title">{{name}}</div></div>':'<div class="img" data-bg-src="{{apiFullpath img}}"><div class="title">{{title}}</div></div>'},viewDetail:function(){"product"==this.model.collection.mediaType?App.router.navigate("product/"+this.model.id):App.router.navigate("topic/"+this.model.id)}})});App.Pages.Brand=new(App.PageView.extend({initPage:function(){this.brand=new t,this.products=new i,this.topics=new o,this.views={brand:new a({model:this.brand,el:this.$(".brand-wrapper")}),products:new s({collection:this.products,el:this.$(".brand-products .media-list")}),topics:new s({collection:this.topics,el:this.$(".brand-topics .media-list")})}},render:function(){var t=this.options.brandId;this.brand.fetch({dataType:"jsonp",data:{id:t}}),this.products.fetch({dataType:"jsonp",data:{id:t,start:0,size:e}}),this.topics.fetch({dataType:"jsonp",data:{id:t,start:0,size:e}})}}))({el:$("#view-brand")})}(),function(){var e=4,t=Amour.Model.extend({url:Amour.APIRoot+"beacon/admin/getTopic.do"}),i=Amour.Collection.extend({url:Amour.APIRoot+"beacon/data/listItemByTid.do"}),o=Amour.Collection.extend({url:Amour.APIRoot+"beacon/data/getAllCommentByTopic.do"}),a=Amour.ModelView.extend({template:App.getTemplate("topic-detail")}),s=Amour.CollectionView.extend({ModelView:Amour.ModelView.extend({events:{click:"viewDetail"},className:"media-item",template:'<div class="img" data-bg-src="{{apiFullpath img}}"></div><div class="content"><div><span class="brand">{{brand.name}}</span></div><div class="name">{{name}}</div><div class="text-success">{{price}}</div></div>',viewDetail:function(){App.router.navigate("product/"+this.model.id)}})}),n=Amour.CollectionView.extend({ModelView:Amour.ModelView.extend({className:"comment-item",template:'<div class="avatar img" data-bg-src="{{apiFullpath user.img}}"></div><div class="like">{{like}}</div><div class="name">{{user.nickname}}</div><div class="time">{{formatted_date}}</div><div class="reply">{{reply}}</div>',serializeData:function(){var e=Amour.ModelView.prototype.serializeData.call(this);return e.formatted_date=moment(e.createTime).format("MM月DD日 HH:mm"),e.like=e.like||"",e}})});App.Pages.Topic=new(App.PageView.extend({initPage:function(){this.topic=new t,this.products=new i,this.comments=new o,this.views={topic:new a({model:this.topic,el:this.$(".topic-wrapper")}),products:new s({collection:this.products,el:this.$(".topic-products .media-list")}),comments:new n({collection:this.comments,el:this.$(".comments-list")})}},render:function(){var t=this.options.topicId;this.topic.fetch({dataType:"jsonp",data:{id:t}}),this.products.fetch({dataType:"jsonp",data:{id:t,start:0,size:e}}),this.comments.fetch({dataType:"jsonp",data:{tid:t,size:10,max_id:null}})}}))({el:$("#view-topic")})}(),App.start();